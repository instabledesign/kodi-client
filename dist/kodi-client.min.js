!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.KodiClient=b()}(this,function(){var a="2.0",b=1e3,c=-32700,d=function(a,b){for(var c in b)a.hasOwnProperty(c)&&"object"==typeof a[c]&&"object"==typeof b[c]?d(a[c],b[c]):a[c]=b[c]},e=function(a,b){var c=a.prototype;a.prototype=Object.create(b.prototype);for(var d in c)a.prototype[d]&&(a.prototype["_"+d]=a.prototype[d]),a.prototype[d]=c[d];Object.defineProperty(a.prototype,"constructor",{enumerable:!1,value:a}),Object.defineProperty(a.prototype,"_parent",{enumerable:!1,value:b})},f=function(a){return Object.keys(a).map(function(b){return a[b]})},g=function(a,b,c){this.message=a||"",this.code=b,this.parent=c};g.prototype.toString=function(){var a=function(b){var c=b.message;return b.parent&&(c+="\n"+a(b.parent)),c};return a(this)};var h=function(a,b){this.message=a,this.code=b};e(h,g);var i=function(a,b,c){this._parent.call(this,'Need to be an "'+b+'". "'+typeof a+'" given.'+(c||""))};e(i,g);var j=function(a,b){this.request=a,this._parent.call(this,'Invalid request "'+a+'".',null,b)};e(j,g);var k=function(b,c,d){this.jsonrpc=a,this.id=d||0,this.method=b,this.params=c||{}};k.prototype.toString=function(){return JSON.stringify(this)};var l=function(b){if(void 0==b||""==b)throw new g("The JSON-RPC is empty.");try{Object.assign(this,JSON.parse(b))}catch(d){throw new h("The JSON-RPC response is not valid.",c)}if(this.hasOwnProperty("jsonrpc")&&(""==this.jsonrpc||this.jsonrpc<a))throw new h("The JSON-RPC response version is not supported.");if(!this.hasOwnProperty("result")&&!this.hasOwnProperty("error"))throw new g("The JSON-RPC response must have a result or error property.")};l.prototype={toString:function(){return JSON.stringify(this)},isError:function(){return this.hasOwnProperty("error")},getError:function(){return this.isError()?{}:!1},getResult:function(){return this.result}};var m=function(a){this.listeners={};for(var b in a)this.listeners[a[b]]=[]};m.prototype={hasListener:function(a){return this.listeners.hasOwnProperty(a)},on:function(a,b){if(!this.hasListener(a))throw new g('Event "'+a+"\" does'nt exist.");if("function"!=typeof b)throw new i(b,"function");this.listeners[a].push(b)},fire:function(a,b){if(!this.hasListener(a))throw new g('Event "'+a+"\" does'nt exist.");for(var c in this.listeners[a])this.listeners[a][c](b)}};var n=function(a){this._parent.call(this,["request","message","error"]);var b=this;if(window.XMLHttpRequest?this.xhr_object=new XMLHttpRequest:window.ActiveXObject&&(this.xhr_object=new ActiveXObject("Microsoft.XMLHTTP")),void 0===this.xhr_object)throw new g("Browser not support XMLHTTPRequest.");this.options={open:{method:null,url:"",async:!0,username:null,password:null},headers:{"Content-type":"application/json"}},d(this.options,a),b.onready=new Promise(function(a,c){try{b.xhr_object.open.apply(b.xhr_object,f(b.options.open)),a()}catch(d){c(d)}})};n.prototype={send:function(a){var b=this;return new Promise(function(c,d){b.xhr_object.onreadystatechange=function(){4==b.xhr_object.readyState&&(200!==b.xhr_object.status?(d(b.xhr_object.statusText),b.fire("error",b.xhr_object.statusText)):b.fire("message",b.xhr_object))};for(var e in b.options.headers)b.xhr_object.setRequestHeader(e,b.options.headers[e]);b.fire("request",{request:a,resolve:c,reject:d}),b.xhr_object.send(a)})},getResponseData:function(a){return a.responseText}},e(n,m);var o=function(a){this._parent.call(this,["request","message","error"]);var b=this;if("string"!=typeof a.url)throw new i(a.url,"string");if(a.onmessage&&"function"!=typeof a.onmessage)throw new i(a.onmessage,"function");if(a.onerror&&"function"!=typeof a.onerror)throw new i(a.onerror,"function");if(a.onclose&&"function"!=typeof a.onclose)throw new i(a.onclose,"function");var c=1;this.options={url:a.url,onmessage:function(){},onerror:function(){},onclose:function(){}},d(this.options,a),b.websocket=new WebSocket(b.options.url),b.onready=new Promise(function(a,d){b.websocket.onopen=function(e){b.websocket.readyState==c?a(e):(b.fire("error",e),d(e))}}),b.websocket.onmessage=function(a){b.fire("message",a)},b.websocket.onerror=function(a){b.fire("error",a)}};o.prototype={send:function(a){var b=this;return new Promise(function(c,d){b.onready.then(function(){b.fire("request",{request:a,resolve:c,reject:d}),b.websocket.send(a)})})},getData:function(a){return a.data}},e(o,m);var p=function(a){this.jsonschema=a};p.prototype={validate:function(a){try{this.validateMethod(a.method),this.validateParams(a.method,a.params)}catch(b){throw new j(a,b)}return!0},validateMethod:function(a){var c=Object.keys(this.jsonschema.methods);if(void 0===a||""===a)throw new g("Request methods is required. Method list "+c.join(", "),b);if(!this.hasMethod(a))throw new g('Request method "'+a+"\" doesn't exist.",b)},validateParams:function(a,b){var c=this.jsonschema.methods[a],d=c.params;if(0===d.length){if(0===f(b).length)return!0;throw new g('Request method "'+a+'" take no params. Excessive param '+JSON.stringify(b)+" given.")}try{for(var e in b)this.validateParam(d,e,b[e])}catch(h){throw new g('Invalid param for request method "'+a+'".',null,h)}},validateParam:function(a,b,c){var d;for(var e in a)if(a[e].name===b){d=a[e];break}if(void 0===d)throw new g('Unexpected param "'+b+'" given.');var f=typeof c;if(f!==d.type)throw new g('Wrong param type for "'+b+'". Expected "'+d.type+'", "'+f+'"given.')},hasMethod:function(a){return this.jsonschema.methods.hasOwnProperty(a)},hasNotifications:function(a){return this.jsonschema.notifications.hasOwnProperty(a)}};var q=function(a){var b=this;if(this.callId=1,this.calls=[],this.options={websocket:{},ajax:{}},d(this.options,a),0!==Object.getOwnPropertyNames(this.options.websocket).length&&"function"==typeof window.WebSocket&&(this.transport=new o(this.options.websocket)),void 0===this.transport&&0!==Object.getOwnPropertyNames(this.options.ajax).length&&(window.XMLHttpRequest||window.ActiveXObject)&&(this.transport=new n(this.options.ajax)),void 0===this.transport)throw new g("No transport is supported.");this.transport.on("message",function(a){b.handleMessageEvent(a)}),this.transport.on("request",function(a){b.handleRequestEvent(a)}),b.onready=new Promise(function(a,c){b.transport.onready.then(function(){return b.send("JSONRPC.Introspect").then(function(c){b.requestValidator=new p(c.getResult()),a()})})["catch"](function(){c()})})};return q.prototype={send:function(a,b,c){var d=this.createRequest(a,b,c);try{this.requestValidator&&this.requestValidator.validate(d)}catch(e){return Promise.reject(e)}return this.transport.send(d)},createRequest:function(a,b,c){return new k(a,b,c||this.callId++)},createResponse:function(a){return new l(a)},handleMessageEvent:function(a){var b=this.createResponse(this.transport.getData(a));if(this.calls[b.id]){var c=this.calls[b.id];b.error?c.reject(b):c.resolve(b)}},handleRequestEvent:function(a){this.calls[a.request.id]=a}},q});
!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.KodiClient=b()}(this,function(){var a="2.0",b=-32700,c=function(a,b){for(var d in b)a.hasOwnProperty(d)&&"object"==typeof a[d]&&"object"==typeof b[d]?c(a[d],b[d]):a[d]=b[d]},d=function(a,b){var c=a.prototype;a.prototype=Object.create(b.prototype);for(var d in c)a.prototype[d]&&(a.prototype["_"+d]=a.prototype[d]),a.prototype[d]=c[d];Object.defineProperty(a.prototype,"constructor",{enumerable:!1,value:a}),Object.defineProperty(a.prototype,"_parent",{enumerable:!1,value:b})},e=function(a,b){this.message=a||"",this.code=b};e.prototype.toString=function(){return this.message};var f=function(a,b){this.message=a,this.code=b};d(f,e);var g=function(a,b,c){this._parent.call(this,'Need to be an "'+b+'". "'+typeof a+'" given.'+(c||""))};d(g,e);var h=function(b,c,d){this.jsonrpc=a,this.id=d||0,this.method=b,this.params=c||{}};h.prototype.toString=function(){return JSON.stringify(this)};var i=function(c){if(void 0==c||""==c)throw new e("The JSON-RPC is empty.");try{Object.assign(this,JSON.parse(c))}catch(d){throw new f("The JSON-RPC response is not valid.",b)}if(this.hasOwnProperty("jsonrpc")&&(""==this.jsonrpc||this.jsonrpc<a))throw new f("The JSON-RPC response version is not supported.");if(!this.hasOwnProperty("result")&&!this.hasOwnProperty("error"))throw new e("The JSON-RPC response must have a result or error property.")};i.prototype={toString:function(){return JSON.stringify(this)},isError:function(){return this.hasOwnProperty("error")},getError:function(){return this.isError()?{}:!1},getResult:function(){return this.result}};var j=function(a){this.listeners={};for(var b in a)this.listeners[a[b]]=[]};j.prototype={hasListener:function(a){return this.listeners.hasOwnProperty(a)},on:function(a,b){if(!this.hasListener(a))throw new e('Event "'+a+"\" does'nt exist.");if("function"!=typeof b)throw new g(b,"function");this.listeners[a].push(b)},fire:function(a,b){if(!this.hasListener(a))throw new e('Event "'+a+"\" does'nt exist.");for(var c in this.listeners[a])this.listeners[a][c](b)}};var k=function(a){this._parent.call(this,["request","message","error"]);var b=this;if(window.XMLHttpRequest?this.xhr_object=new XMLHttpRequest:window.ActiveXObject&&(this.xhr_object=new ActiveXObject("Microsoft.XMLHTTP")),void 0===this.xhr_object)throw new e("Browser not support XMLHTTPRequest.");this.options={open:{method:null,url:"",async:!0,username:null,password:null},headers:{"Content-type":"application/json"}},c(this.options,a),b.onready=new Promise(function(a,c){try{b.xhr_object.open.apply(b.xhr_object,Object.keys(b.options.open).map(function(a){return b.options.open[a]})),a()}catch(d){c(d)}})};k.prototype={send:function(a){var b=this;return new Promise(function(c,d){b.xhr_object.onreadystatechange=function(){4==b.xhr_object.readyState&&(200!==b.xhr_object.status?(d(b.xhr_object.statusText),b.fire("error",b.xhr_object.statusText)):b.fire("message",b.xhr_object))};for(var e in b.options.headers)b.xhr_object.setRequestHeader(e,b.options.headers[e]);b.fire("request",{request:a,resolve:c,reject:d}),b.xhr_object.send(a)})},getResponseData:function(a){return a.responseText}},d(k,j);var l=function(a){this._parent.call(this,["request","message","error"]);var b=this;if("string"!=typeof a.url)throw new g(a.url,"string");if(a.onmessage&&"function"!=typeof a.onmessage)throw new g(a.onmessage,"function");if(a.onerror&&"function"!=typeof a.onerror)throw new g(a.onerror,"function");if(a.onclose&&"function"!=typeof a.onclose)throw new g(a.onclose,"function");var d=1;this.options={url:a.url,onmessage:function(){},onerror:function(){},onclose:function(){}},c(this.options,a),b.websocket=new WebSocket(b.options.url),b.onready=new Promise(function(a,c){b.websocket.onopen=function(e){b.websocket.readyState==d?a(e):(b.fire("error",e),c(e))}}),b.websocket.onmessage=function(a){b.fire("message",a)},b.websocket.onerror=function(a){b.fire("error",a)}};l.prototype={send:function(a){var b=this;return new Promise(function(c,d){b.onready.then(function(){b.fire("request",{request:a,resolve:c,reject:d}),b.websocket.send(a)})})},getData:function(a){return a.data}},d(l,j);var m=function(a){var b=this;if(this.callId=1,this.calls=[],this.options={websocket:{},ajax:{}},c(this.options,a),0!==Object.getOwnPropertyNames(this.options.websocket).length&&"function"==typeof window.WebSocket&&(this.transport=new l(this.options.websocket)),void 0===this.transport&&0!==Object.getOwnPropertyNames(this.options.ajax).length&&(window.XMLHttpRequest||window.ActiveXObject)&&(this.transport=new k(this.options.ajax)),void 0===this.transport)throw new e("No transport is supported.");this.transport.on("message",function(a){b.handleResponseEvent(a)}),this.transport.on("request",function(a){b.handleRequestEvent(a)})};return m.prototype={request:function(a,b,c){return this.transport.send(this.createRequest(a,b,c))},createRequest:function(a,b,c){return new h(a,b,c||this.callId++)},createResponse:function(a){return new i(a)},handleResponseEvent:function(a){var b=this.createResponse(this.transport.getData(a));if(this.calls[b.id]){var c=this.calls[b.id];b.error?c.reject(b):c.resolve(b)}},handleRequestEvent:function(a){this.calls[a.request.id]=a}},m});